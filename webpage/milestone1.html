<!DOCTYPE html>
<html>
  <head>
    <!-- Set the character encoding for the document -->
    <meta charset="UTF-8">
    <!-- Set the title of the document -->
    <title>CBC Test Automation</title>
    <!-- Link the stylesheet to the HTML document -->
    <link rel="stylesheet" href="{{ url_for('static', filename='milestone1.css') }}">
    
  </head>
  <body>
    <!-- header section of the page, which contains a navigation bar -->
    <header>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="milestone1.html">AutoCBC</a></li>
          <li><a href="diseasedetection.html">Disease Detection</a></li>
        </ul>
      </nav>
    </header>
    <!-- main content of the page -->
    <h1>AutoCBC</h1>

    <!-- form that allows users to upload images of the cells and triggers the screen to change when a file is uploaded -->
    <form action="/metrics">
      <label for="file" id="file-label"></label>
      <!-- input element that allows users to select one or more images to upload -->
      <input type="file" id="file" name="image" accept="image/*" style="display: none;" onchange="loadFiles(event)" multiple>
      <!-- button that allows users to select images to upload -->
      <button type="button" class="process-image-button" onclick="document.getElementById('file').click();">Choose Image(s)</button>
      <br>
    </form>
    
    <!-- script that defines a function to be called when an image is uploaded -->
    <script>
      var loadFiles = function(event) {
        var images = document.getElementById('output');
        for (var i = 0; i < event.target.files.length; i++) {
          var image = document.createElement('img');
          image.src = URL.createObjectURL(event.target.files[i]);
          image.width = 100;
          images.appendChild(image);
        }
        // Show the process input button and the success message
        document.getElementById("processButton").style.display = "block";
        document.getElementById("successMessage").style.display = "block";
      };
    </script>
    
    <!-- image element to display uploaded images -->
    <img id="output" />

    <!-- display a success message after images are uploaded -->
    <p id="successMessage" style="display:none;color: rgb(0, 255, 0);text-align: center; font-family: 'Segoe UI', sans-serif; font-weight: bold;">Images have been successfully uploaded</p>

    <!-- button that triggers the model to process the uploaded images -->
    <button type="button" class="process-image-button"  id= "processButton"  style="display: none;" onclick="buttonEvent()">Process Input</button>

    <!-- Create a table to display the results of the image processing -->
    <table style="border-collapse: collapse;" id="ratios">
      <tr>
        <th style="text-align:center">Cell Type</th>
        <th style="text-align:center">Percentage</th>
        <th style="text-align:center">Normal Range</th>
      </tr>
      <tr>
        <td style="border: none; text-align:center">RBC</td>
        <td style="border: none; text-align:center" id="rbcVal"></td>
        <td style="border: none; text-align:center"> 93 - 97</td>
      </tr>
      <tr>
        <td style="border: none; text-align:center">WBC</td>
        <td style="border: none; text-align:center" id="wbcVal"></td>
        <td style="border: none; text-align:center">0.5 - 2</td>
      </tr>
      <tr>
        <td style="border: none; text-align:center">Platelets</td>
        <td style="border: none; text-align:center" id="plateletsVal"></td>
        <td style="border: none; text-align:center">1 - 3</td>
      </tr>
    </table>


    <img id="result_image" style="display:none;" />

    <script>
// javascript code that sends the information to the model
    var buttonEvent = function() {      
      var images = document.getElementById('file').files;
      if (images.length > 0) {
        clearElemsAndAddTable();
        // Make a POST request to the server
        var formData = new FormData();
        for (var i = 0; i < images.length; i++) {
          formData.append('image', images[i]);
        }
        fetch('/metrics', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Update the HTML elements
          document.getElementById('rbcVal').innerHTML = data.RBC.toFixed(2);
          document.getElementById('wbcVal').innerHTML = data.WBC.toFixed(2);
          document.getElementById('plateletsVal').innerHTML = data.Platelets.toFixed(2);
        })
        .catch(error => console.error(error));

        var formData = new FormData();
        formData.append('image', images[0]);
        fetch('/image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('result_image').src = data.image_url; // update the image src
          document.getElementById('result_image').style.display = 'block'; // show the image
        })
        .catch(error => console.error(error));

      }
    }

      var clearElemsAndAddTable = function() {
        var image = document.getElementById('file').files[0];
        if (image) {
          var form = document.getElementsByTagName('form')[0];
          var button = document.getElementsByClassName('process-image-button')[0];
          document.getElementById("processButton").style.display = "none";
          document.getElementById("successMessage").style.display = "none";
          form.parentNode.removeChild(form);
          button.parentNode.removeChild(button);

          const myTable = document.getElementById('ratios');
          myTable.style.display = 'table';
          return true
        } else {
          alert('Please upload an image to process first');
          return false
        }
      };
    </script>

    <footer>
      <p>Team 3: Ritvik Prabhu, Amrita Ballurkar, Bhargav Iyer</p>
    </footer>
  </body>
</html>